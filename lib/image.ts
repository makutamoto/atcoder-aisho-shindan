import chrome from 'chrome-aws-lambda'
import { convert } from 'convert-svg-to-png'

const SVG = (
  nameA: string,
  colorA: string,
  avatarA: string,
  nameB: string,
  colorB: string,
  avatarB: string,
  compatibility: number,
  compatibilityColor: string
) => `\
<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="630">
    <defs>
        <clipPath id="round-image" clipPathUnits="objectBoundingBox">
            <circle cx="0.5" cy="0.5" r="0.5" />
        </clipPath>
        <filter id="back-shadow">
            <feDropShadow flood-opacity="0.75" stdDeviation="16" />
        </filter>
    </defs>
    <rect y="128" width="1200" height="502" fill="#F5F5F5" />
    <rect filter="url(#back-shadow)" x="64" y="128" width="1072" height="502" fill="#FFFFFF" />
    <rect width="1200" height="128" fill="#222222" />
    <g transform="translate(44.23, 39.82)">
        <path d="M17.656 2.984L13.624 2.888C13.672 3.464 13.576 4.328 13.528 5.192C13.432 6.248 13.288 7.49601 13.144 8.888C12.04 8.936 10.984 8.936 9.87999 8.936C7.816 8.936 3.63999 8.60001 1.95999 8.312L2.05599 11.912C4.02399 12.056 7.76799 12.248 9.832 12.248C10.792 12.248 11.752 12.248 12.76 12.2C12.568 14.456 12.328 16.856 12.232 19.256C5.608 22.328 0.231995 28.616 0.231995 34.808C0.231995 38.888 2.728 40.856 5.896 40.856C8.53599 40.856 11.416 39.8 14.056 38.216C14.296 39.176 14.536 40.088 14.824 40.904L18.28 39.848C17.896 38.648 17.512 37.352 17.128 35.96C21.208 32.504 25.096 27.176 27.832 20.36C32.296 21.656 34.744 24.92 34.744 28.568C34.744 34.808 29.368 39.272 20.68 40.184L22.744 43.4C33.88 41.624 38.44 35.672 38.44 28.76C38.44 23.48 34.888 19.064 28.888 17.48C28.888 17.384 28.936 17.336 28.936 17.288C29.176 16.52 29.608 15.224 29.896 14.552L26.104 13.592C26.056 14.408 25.816 15.656 25.576 16.376C25.528 16.568 25.48 16.712 25.432 16.856C24.856 16.808 24.28 16.808 23.656 16.808C21.208 16.808 18.28 17.24 15.592 18.008C15.736 15.992 15.88 13.976 16.12 12.104C21.976 11.816 28.36 11.144 33.4 10.28L33.352 6.728C28.456 7.88 22.6 8.504 16.504 8.79201C16.696 7.4 16.888 6.15201 17.08 5.144C17.224 4.472 17.416 3.608 17.656 2.984ZM15.448 23.336C15.448 22.664 15.448 22.04 15.496 21.368C17.704 20.552 20.488 19.832 23.608 19.832C23.896 19.832 24.184 19.832 24.424 19.832C22.408 25.208 19.48 29.096 16.264 32.12C15.784 29.336 15.448 26.408 15.448 23.336ZM3.87999 34.184C3.87999 30.248 7.432 25.496 12.088 22.856C12.088 23.144 12.088 23.432 12.088 23.72C12.088 27.32 12.568 31.208 13.24 34.616C10.792 36.344 8.488 37.16 6.616 37.16C4.792 37.16 3.87999 36.152 3.87999 34.184Z" fill="white"/>
        <path d="M64.648 2.888L60.424 2.504C60.328 5.096 59.656 8.12 58.936 10.808C57.064 10.952 55.24 11.048 53.512 11.048C51.496 11.048 49.432 10.952 47.656 10.712L47.896 14.312C49.72 14.408 51.736 14.456 53.512 14.456C54.904 14.456 56.344 14.408 57.784 14.312C55.576 19.928 51.496 27.608 47.512 32.264L51.208 34.184C55.048 29 59.32 20.696 61.672 13.928C64.84 13.496 67.864 12.872 70.408 12.152L70.312 8.552C67.864 9.368 65.272 9.94401 62.776 10.328C63.544 7.544 64.216 4.616 64.648 2.888ZM62.008 36.2C62.008 33.992 64.408 32.36 67.912 32.36C69.64 32.36 71.32 32.6 72.856 33.08C72.904 33.896 72.904 34.616 72.904 35.24C72.904 37.88 71.56 39.992 67.576 39.992C63.832 39.992 62.008 38.456 62.008 36.2ZM75.976 17.72H72.232C72.328 21.128 72.568 25.88 72.76 29.816C71.272 29.48 69.688 29.336 68.056 29.336C62.632 29.336 58.456 32.12 58.456 36.536C58.456 41.288 62.776 43.448 68.056 43.448C74.008 43.448 76.456 40.328 76.456 36.488C76.456 35.912 76.456 35.24 76.408 34.472C79.528 36.008 82.12 38.168 84.184 39.992L86.248 36.728C83.752 34.616 80.392 32.264 76.264 30.776C76.168 27.8 75.976 24.68 75.928 22.904C75.88 21.176 75.88 19.688 75.976 17.72ZM85.576 19.016L87.736 15.848C85.48 14.12 80.008 11 76.552 9.46401L74.584 12.392C77.8 13.832 82.984 16.808 85.576 19.016Z" fill="white"/>
        <path d="M117.784 29.528L114.184 29.192C113.8 31.208 113.464 32.984 113.464 34.856C113.464 39.608 117.592 41.912 125.176 41.912C128.68 41.912 131.848 41.624 134.44 41.24L134.584 37.352C131.656 37.976 128.344 38.312 125.224 38.312C118.36 38.312 117.112 36.104 117.112 33.848C117.112 32.6 117.352 31.112 117.784 29.528ZM112.264 3.224L107.656 2.84C107.752 3.848 107.704 5.48001 107.512 6.82401C107.368 7.784 107.128 9.32 106.792 11C104.92 11.144 103.192 11.24 101.608 11.24C99.88 11.24 98.152 11.192 95.848 10.904L95.992 14.648C97.72 14.744 99.448 14.84 101.56 14.84C102.904 14.84 104.392 14.792 105.976 14.696C105.592 16.424 105.16 18.248 104.728 19.832C102.952 26.6 99.544 36.344 96.664 41.288L100.888 42.728C103.384 37.448 106.648 27.56 108.376 20.744C108.952 18.632 109.48 16.424 109.912 14.312C113.272 13.928 116.776 13.4 119.896 12.68V8.888C116.968 9.656 113.8 10.232 110.68 10.616C110.968 9.32 111.208 8.072 111.4 7.064C111.592 6.104 111.976 4.28 112.264 3.224ZM116.776 17.864V21.416C119.752 21.08 122.68 20.936 125.704 20.936C128.488 20.936 131.32 21.176 133.768 21.512L133.864 17.864C131.272 17.576 128.392 17.432 125.56 17.432C122.488 17.432 119.32 17.624 116.776 17.864Z" fill="white"/>
        <path d="M182.584 24.2C182.584 14.456 175.432 6.536 164.2 6.536C152.488 6.536 143.224 15.656 143.224 26.072C143.224 33.992 147.496 38.888 151.768 38.888C156.232 38.888 160.024 33.848 162.952 23.96C164.296 19.496 165.208 14.6 165.832 10.136C173.992 10.808 178.648 16.808 178.648 24.056C178.648 32.36 172.6 36.92 166.456 38.312C165.352 38.552 163.864 38.792 162.328 38.936L164.584 42.488C175.96 41 182.584 34.28 182.584 24.2ZM146.968 25.736C146.968 19.208 152.632 11.336 161.848 10.184C161.32 14.6 160.36 19.16 159.16 23.144C156.712 31.256 154.168 34.472 151.912 34.472C149.752 34.472 146.968 31.784 146.968 25.736Z" fill="white"/>
        <path d="M209.805 32.0938H195.508L192.297 41H187.656L200.688 6.87501H204.625L217.68 41H213.062L209.805 32.0938ZM196.867 28.3906H208.469L202.656 12.4297L196.867 28.3906Z" fill="white"/>
        <path d="M227.055 9.50001V15.6406H231.789V18.9922H227.055V34.7188C227.055 35.7344 227.266 36.5 227.688 37.0156C228.109 37.5156 228.828 37.7656 229.844 37.7656C230.344 37.7656 231.031 37.6719 231.906 37.4844V41C230.766 41.3125 229.656 41.4688 228.578 41.4688C226.641 41.4688 225.18 40.8828 224.195 39.7109C223.211 38.5391 222.719 36.875 222.719 34.7188V18.9922H218.102V15.6406H222.719V9.50001H227.055Z" fill="white"/>
        <path d="M262.656 30.1719C262.234 33.7813 260.898 36.5703 258.648 38.5391C256.414 40.4922 253.438 41.4688 249.719 41.4688C245.688 41.4688 242.453 40.0234 240.016 37.1328C237.594 34.2422 236.383 30.375 236.383 25.5313V22.25C236.383 19.0781 236.945 16.2891 238.07 13.8828C239.211 11.4766 240.82 9.63282 242.898 8.35157C244.977 7.05469 247.383 6.40626 250.117 6.40626C253.742 6.40626 256.648 7.42188 258.836 9.45313C261.023 11.4688 262.297 14.2656 262.656 17.8438H258.133C257.742 15.125 256.891 13.1563 255.578 11.9375C254.281 10.7188 252.461 10.1094 250.117 10.1094C247.242 10.1094 244.984 11.1719 243.344 13.2969C241.719 15.4219 240.906 18.4453 240.906 22.3672V25.6719C240.906 29.375 241.68 32.3203 243.227 34.5078C244.773 36.6953 246.938 37.7891 249.719 37.7891C252.219 37.7891 254.133 37.2266 255.461 36.1016C256.805 34.9609 257.695 32.9844 258.133 30.1719H262.656Z" fill="white"/>
        <path d="M266.992 28.0859C266.992 25.6016 267.477 23.3672 268.445 21.3828C269.43 19.3984 270.789 17.8672 272.523 16.7891C274.273 15.7109 276.266 15.1719 278.5 15.1719C281.953 15.1719 284.742 16.3672 286.867 18.7578C289.008 21.1484 290.078 24.3281 290.078 28.2969V28.6016C290.078 31.0703 289.602 33.2891 288.648 35.2578C287.711 37.2109 286.359 38.7344 284.594 39.8281C282.844 40.9219 280.828 41.4688 278.547 41.4688C275.109 41.4688 272.32 40.2734 270.18 37.8828C268.055 35.4922 266.992 32.3281 266.992 28.3906V28.0859ZM271.352 28.6016C271.352 31.4141 272 33.6719 273.297 35.375C274.609 37.0781 276.359 37.9297 278.547 37.9297C280.75 37.9297 282.5 37.0703 283.797 35.3516C285.094 33.6172 285.742 31.1953 285.742 28.0859C285.742 25.3047 285.078 23.0547 283.75 21.3359C282.438 19.6016 280.688 18.7344 278.5 18.7344C276.359 18.7344 274.633 19.5859 273.32 21.2891C272.008 22.9922 271.352 25.4297 271.352 28.6016Z" fill="white"/>
        <path d="M294.461 28.1094C294.461 24.2188 295.383 21.0938 297.227 18.7344C299.07 16.3594 301.484 15.1719 304.469 15.1719C307.438 15.1719 309.789 16.1875 311.523 18.2188V5.00001H315.859V41H311.875L311.664 38.2813C309.93 40.4063 307.516 41.4688 304.422 41.4688C301.484 41.4688 299.086 40.2656 297.227 37.8594C295.383 35.4531 294.461 32.3125 294.461 28.4375V28.1094ZM298.797 28.6016C298.797 31.4766 299.391 33.7266 300.578 35.3516C301.766 36.9766 303.406 37.7891 305.5 37.7891C308.25 37.7891 310.258 36.5547 311.523 34.0859V22.4375C310.227 20.0469 308.234 18.8516 305.547 18.8516C303.422 18.8516 301.766 19.6719 300.578 21.3125C299.391 22.9531 298.797 25.3828 298.797 28.6016Z" fill="white"/>
        <path d="M333.133 41.4688C329.695 41.4688 326.898 40.3438 324.742 38.0938C322.586 35.8281 321.508 32.8047 321.508 29.0234V28.2266C321.508 25.7109 321.984 23.4688 322.938 21.5C323.906 19.5156 325.25 17.9688 326.969 16.8594C328.703 15.7344 330.578 15.1719 332.594 15.1719C335.891 15.1719 338.453 16.2578 340.281 18.4297C342.109 20.6016 343.023 23.7109 343.023 27.7578V29.5625H325.844C325.906 32.0625 326.633 34.0859 328.023 35.6328C329.43 37.1641 331.211 37.9297 333.367 37.9297C334.898 37.9297 336.195 37.6172 337.258 36.9922C338.32 36.3672 339.25 35.5391 340.047 34.5078L342.695 36.5703C340.57 39.8359 337.383 41.4688 333.133 41.4688ZM332.594 18.7344C330.844 18.7344 329.375 19.375 328.188 20.6563C327 21.9219 326.266 23.7031 325.984 26H338.688V25.6719C338.562 23.4688 337.969 21.7656 336.906 20.5625C335.844 19.3438 334.406 18.7344 332.594 18.7344Z" fill="white"/>
        <path d="M360.32 19.5313C359.664 19.4219 358.953 19.3672 358.188 19.3672C355.344 19.3672 353.414 20.5781 352.398 23V41H348.062V15.6406H352.281L352.352 18.5703C353.773 16.3047 355.789 15.1719 358.398 15.1719C359.242 15.1719 359.883 15.2813 360.32 15.5V19.5313Z" fill="white"/>
        <path d="M381.742 41H377.242V6.87501H381.742V41Z" fill="white"/>
        <path d="M389.992 41V6.87501H399.625C402.594 6.87501 405.219 7.53126 407.5 8.84376C409.781 10.1563 411.539 12.0234 412.773 14.4453C414.023 16.8672 414.656 19.6484 414.672 22.7891V24.9688C414.672 28.1875 414.047 31.0078 412.797 33.4297C411.562 35.8516 409.789 37.7109 407.477 39.0078C405.18 40.3047 402.5 40.9688 399.438 41H389.992ZM394.492 10.5781V37.3203H399.227C402.695 37.3203 405.391 36.2422 407.312 34.0859C409.25 31.9297 410.219 28.8594 410.219 24.875V22.8828C410.219 19.0078 409.305 16 407.477 13.8594C405.664 11.7031 403.086 10.6094 399.742 10.5781H394.492Z" fill="white"/>
        <path d="M461.115 24.2C461.115 14.456 453.963 6.536 442.731 6.536C431.019 6.536 421.755 15.656 421.755 26.072C421.755 33.992 426.027 38.888 430.299 38.888C434.763 38.888 438.555 33.848 441.483 23.96C442.827 19.496 443.739 14.6 444.363 10.136C452.523 10.808 457.179 16.808 457.179 24.056C457.179 32.36 451.131 36.92 444.987 38.312C443.883 38.552 442.395 38.792 440.859 38.936L443.115 42.488C454.491 41 461.115 34.28 461.115 24.2ZM425.499 25.736C425.499 19.208 431.163 11.336 440.379 10.184C439.851 14.6 438.891 19.16 437.691 23.144C435.243 31.256 432.699 34.472 430.443 34.472C428.283 34.472 425.499 31.784 425.499 25.736Z" fill="white"/>
        <path d="M479.307 14.456H486.171V11.096H479.307V0.824005H475.947V11.096H468.171V14.456H475.515C473.835 21.08 470.427 28.52 467.115 32.504C467.691 33.368 468.603 34.76 468.987 35.768C471.579 32.504 474.075 27.176 475.947 21.656V44.6H479.307V22.76C481.131 25.112 483.291 28.136 484.203 29.72L486.411 26.792C485.403 25.496 480.987 20.408 479.307 18.68V14.456ZM491.691 38.12V29.816H506.235V38.12H491.691ZM506.235 7.01601V15.032H491.691V7.01601H506.235ZM491.691 18.296H506.235V26.552H491.691V18.296ZM488.283 3.656V44.312H491.691V41.432H506.235V44.168H509.739V3.656H488.283Z" fill="white"/>
        <path d="M517.803 23.144C519.051 19.64 519.963 14.216 520.203 10.28L517.515 9.89601C517.179 13.784 516.315 19.016 515.019 22.184L517.803 23.144ZM521.931 44.648H525.483V0.824005H521.931V44.648ZM525.819 9.656C527.163 12.296 528.603 15.752 529.131 17.816L531.819 16.52C531.243 14.504 529.755 11.096 528.315 8.504L525.819 9.656ZM546.891 39.608V27.608H556.683V24.296H546.891V14.36H557.739V10.952H546.891V1.016H543.339V10.952H537.339C538.011 8.60001 538.587 6.104 539.067 3.608L535.611 3.03201C534.507 9.56 532.587 15.992 529.803 20.168C530.667 20.552 532.251 21.32 532.971 21.8C534.267 19.736 535.371 17.24 536.331 14.36H543.339V24.296H533.163V27.608H543.339V39.608H529.611V43.016H558.891V39.608H546.891Z" fill="white"/>
        <path d="M582.939 35.24C582.939 32.888 585.483 31.352 589.083 31.352C590.811 31.352 592.443 31.64 593.979 32.12C594.027 32.744 594.027 33.32 594.027 33.8C594.027 36.968 592.827 39.032 588.795 39.032C585.339 39.032 582.939 37.688 582.939 35.24ZM597.483 4.04H593.163C593.259 4.856 593.355 6.15201 593.355 6.968V12.92C591.867 12.968 590.331 13.016 588.843 13.016C585.963 13.016 583.419 12.872 580.683 12.632V16.232C583.515 16.424 586.011 16.568 588.747 16.568C590.283 16.568 591.819 16.52 593.355 16.472C593.403 20.408 593.691 25.112 593.835 28.808C592.443 28.52 590.955 28.376 589.371 28.376C583.083 28.376 579.483 31.592 579.483 35.624C579.483 39.944 583.035 42.488 589.467 42.488C595.947 42.488 597.771 38.696 597.771 34.76C597.771 34.424 597.771 34.088 597.771 33.752C600.219 35.144 602.619 37.064 605.019 39.32L607.131 36.104C604.635 33.848 601.515 31.448 597.627 29.912C597.435 25.88 597.099 21.08 597.051 16.232C599.931 16.04 602.715 15.752 605.355 15.32V11.624C602.811 12.104 599.979 12.488 597.051 12.728C597.099 10.472 597.147 8.216 597.195 6.92C597.243 5.96 597.339 5 597.483 4.04ZM573.771 4.328L569.547 3.992C569.547 5 569.403 6.296 569.259 7.4C568.635 11.384 567.051 20.552 567.051 27.608C567.051 34.088 567.915 39.368 568.875 42.776L572.235 42.536C572.187 42.008 572.139 41.336 572.139 40.856C572.091 40.28 572.187 39.368 572.331 38.696C572.811 36.344 574.587 31.448 575.739 28.088L573.771 26.552C572.955 28.52 571.803 31.448 571.035 33.608C570.699 31.256 570.555 29.24 570.555 26.936C570.555 21.56 571.995 12.056 572.955 7.592C573.099 6.728 573.483 5.144 573.771 4.328Z" fill="white"/>
        <path d="M630.891 29.384H634.827C633.531 22.184 645.003 20.696 645.003 13.448C645.003 7.92801 640.683 4.472 633.915 4.472C628.683 4.472 624.939 6.68 621.771 10.04L624.363 12.44C627.147 9.512 630.171 8.072 633.435 8.072C638.331 8.072 640.731 10.472 640.731 13.784C640.731 19.256 629.403 21.416 630.891 29.384ZM632.955 41.24C634.635 41.24 636.027 39.992 636.027 38.072C636.027 36.152 634.635 34.856 632.955 34.856C631.227 34.856 629.835 36.152 629.835 38.072C629.835 39.992 631.227 41.24 632.955 41.24Z" fill="white"/>
    </g>
    <image clip-path="url(#round-image)" href="${avatarA}" width="256" height="256" x="159" y="215" />
    <image clip-path="url(#round-image)" href="${avatarB}" width="256" height="256" x="788" y="215" />
    <text x="287.5" y="487" alignment-baseline="hanging" text-anchor="middle" font-size="48" font-family="sans-serif" fill="${colorA}">${nameA}</text>
    <text x="914.5" y="487" alignment-baseline="hanging" text-anchor="middle" font-size="48" font-family="sans-serif" fill="${colorB}">${nameB}</text>
    <text x="600" y="316" alignment-baseline="hanging" text-anchor="middle" font-size="96" font-family="sans-serif" fill="${compatibilityColor}">${compatibility}%</text>
</svg>
`

export async function generateImage(
  nameA: string,
  colorA: string,
  avatarA: string,
  nameB: string,
  colorB: string,
  avatarB: string,
  compatibility: number,
  compatibilityColor: string
): Promise<Buffer> {
  return await convert(
    SVG(
      nameA,
      colorA,
      avatarA,
      nameB,
      colorB,
      avatarB,
      compatibility,
      compatibilityColor
    ),
    {
      puppeteer: {
        args: chrome.args,
        executablePath: await chrome.executablePath,
        headless: chrome.headless,
      },
    }
  )
}
